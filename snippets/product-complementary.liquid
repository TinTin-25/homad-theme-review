{%- assign column_1 = block.settings.column1 | plus: 0 -%}
{%- assign column_2 = block.settings.column2 | plus: 0 -%}
{%- assign column_3 = block.settings.column3 | plus: 0 -%}
{%- assign column_4 = block.settings.column4 | plus: 0 -%}
{%- assign sold_out = true -%}
<complementary-products class="complementary-products d-block slick-carousel__variableWidth {{ block.settings.block_margin_m }} {{ block.settings.block_margin }}" data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit={{ block.settings.products_to_show }}&intent=complementary">
    {%- if recommendations.performed and recommendations.products_count > 0 -%}
        {%- if block.settings.heading != blank -%}
            <h5 class="heading mb-3">
                <span>{{ block.settings.heading }}</span>
            </h5>
        {%- endif -%}
        <div class=" complementary-products__content">
            <div class="js-complementary slick-carousel row g-3 g-md-4"
                data-nav="true"
                data-variableWidth="true"
                data-columnone="{{ column_1 }}"
                data-columntwo="{{ column_2 }}"
                data-columnthree="{{ column_3 }}"
                style="--bs-gutter-x: 16px;"
            >
                {%- for product in recommendations.products -%}
                    {%- if product.available -%}
                        {%- assign sold_out = false -%}
                    {%- endif -%}
                    {%- assign on_sale = false -%}
                    {%- if product.compare_at_price > product.price -%}
                        {%- assign on_sale = true -%}
                    {%- endif -%}
                    {%- if product.metafields.custom.pre_order and settings.pre-order and variant.inventory_policy == "continue" -%}
                        {%- assign preOrder = true -%}
                    {%- else -%}
                        {%- assign preOrder = false -%}
                    {%- endif -%}
                    <div class="slick-carousel__item">
                        <div class="product-card product-grid box-width">
                            <div class="product-grid__inner">
                                <div class="product-card__image-wrapper mb-2">
                                    <a class="product-card__image-link" href="{{ product.url }}" title="{{ product.title | strip_html }}">
                                        <div class="product-card__img-primary{% if product.media[1] != nil and settings.show_secondary_image %} img-primary{% endif %}">
                                            {% render 'img-global', image: product.featured_media, image_ratio: settings.image_ratio, crop: image_crop, image_style: true %}
                                        </div>
                                        {%- if product.media[1] != nil and settings.show_secondary_image -%}
                                            <div class="img-secondary position-absolute">
                                                {% render 'img-global', image: product.media[1], image_ratio: settings.image_ratio, crop: image_crop , image_style: true %}
                                            </div>
                                        {%- endif -%}
                                    </a>
                                    {%- unless sold_out -%}
                                        {%- if settings.product_card_addtocart or block.settings.complementary_addtocart -%}
                                            <div class="product-card__buttons position-absolute bottom-0 start-0 end-0 mx-2">
                                                {%- assign variant_count = product.variants | size -%}
                                                <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" class="form-addtocart" data-product-form>
                                                    <input type="hidden" name="id" value="{{ variant.id }}" />
                                                    {%- if variant_count > 1 -%}
                                                        {%- if settings.quickadd_enable -%}
                                                            <a class="js-btn-quickadd btn btn--action btn--add-to-cart" href="javascript:void(0);" data-preorder="{{ preOrder }}" data-handle="{{ product.handle }}" title="{{ 'products.product.quickadd' | t }}" data-color-label="{{ settings.product_cart_swatch_label | escape }}">
                                                                <span class="text">{{ 'products.product.quickadd' | t }}</span>
                                                            </a>
                                                        {%- else -%}
                                                            <a class="btn btn--action btn--add-to-cart" href="{{ product.url }}" title="{{ 'products.product.select_options' | t }}">
                                                                <span class="text">{{ 'products.product.select_options' | t }}</span>
                                                            </a>
                                                        {%- endif -%}
                                                    {%- else -%}
                                                        <button class="btn btn--action btn--add-to-cart" type="submit" value="Submit" title="{{ 'products.product.add_to_cart' | t }}">
                                                            <span class="text">{{ 'products.product.add_to_cart' | t }}</span>
                                                        </button>
                                                    {%- endif -%}
                                                </form>
                                            </div>
                                        {%- endif -%}
                                    {%- endunless -%}
                                </div>
                                <div class="product-card__content">
                                    <div class="product-card__content--inner">
                                        <div class="product-card__name fs-13 line-clamp-1 mb-2">
                                            <a class="line-title fw-bold
                                              " href="{{ product.url }}" title="{{ product.title | strip_html }}">{{ product.title }}</a>
                                        </div>
                                        <div class="product-group-price d-flex align-items-center lh-1">
                                            <div class="fs-13 product-price{% if on_sale %} product-price__has-sale{% endif %}">{{ product.price | money }}</div>
                                            {%- if on_sale -%}
                                                <div class="product-price product-price--regular ms-1">{{ product.compare_at_price | money }}</div>
                                            {%- endif -%}
                                            {%- if product.price_varies == false and variant.unit_price_measurement -%}
                                                {%- capture unit_price_separator -%}
                                                    <span>/</span>
                                                {%- endcapture -%}
                                                {%- capture unit_price_base_unit -%}
                                                    <span>
                                                    {%- if variant.unit_price_measurement.reference_value != 1 -%}
                                                        {{- variant.unit_price_measurement.reference_value -}}
                                                    {%- endif -%}
                                                    {{ variant.unit_price_measurement.reference_unit }}
                                                    </span>
                                                {%- endcapture -%}
                                                <span class="product-unit-price">
                                                    <span class="d-none">{{ 'products.general.unit_price' | t }}</span>
                                                    <span>{{ variant.unit_price | money }}</span>{{- unit_price_separator -}}{{- unit_price_base_unit -}}
                                                </span>
                                            {%- endif -%}
                                            {%- if shop.taxes_included and settings.product_card_tax -%}
                                                <span class="ms-2">
                                                    {{ 'products.general.include_taxes' | t }}
                                                </span>
                                            {%- endif -%}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {%- endfor -%}
            </div>
        </div>
    {% endif %}
</complementary-products>
<script>
    class ProductComplementary extends HTMLElement {
        constructor() {
            super();
            const handleIntersection = (entries, observer) => {
                if (!entries[0].isIntersecting) return;
                observer.unobserve(this);
                fetch(this.dataset.url)
                .then(response => response.text())
                .then(text => {
                    const html = document.createElement('div');
                    html.innerHTML = text;
                    const recommendations = html.querySelector('complementary-products');
                    if (recommendations && recommendations.innerHTML.trim().length) {
                        this.innerHTML = recommendations.innerHTML;
                        $('body').trigger('carousel:init', '.js-complementary');
                    }
                })
                .catch(e => {
                    console.error(e);
                });
            }
            new IntersectionObserver(handleIntersection.bind(this), {rootMargin: '0px 0px 200px 0px'}).observe(this);
        }
    }
    customElements.define('complementary-products', ProductComplementary);
</script>